<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Showcasing Sampling Schemes with Sloths • safeHavens</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Showcasing Sampling Schemes with Sloths">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">safeHavens</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/safeHavens.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Showcasing Sampling Schemes with Sloths</h1>
            
      

      <div class="d-none name"><code>safeHavens.Rmd</code></div>
    </div>

    
    
<p><code>safeHavens</code> can be installed directly from github, no
plans are made to release the package to CRAN as it’s user base is
relatively niche relative to a typical R package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># `devtools`, or a similar package, is required to install packages from github</span></span>
<span><span class="co"># install.packages('devtools') </span></span>
<span><span class="co"># devtools::install_github('sagesteppe/safeHavens')</span></span>
<span></span>
<span><span class="co"># lot's of user have issues with devtools, on Windows I believe, but `remotes` tends to work well. </span></span>
<span><span class="co"># install.packages('remotes') # remotes is very similar and  a good alternativ for this use case.</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">'sagesteppe/safeHavens'</span><span class="op">)</span> <span class="co"># blah even same function name!</span></span></code></pre></div>
<p>Once installed <code>safeHavens</code> can be loaded like any other
package, whether they are installed from CRAN or github. We will also
load <code>ggplot2</code> for it’s excellent ability to plot simple
features, and <code>tidyverse</code> for pushing some columns around
etc.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sagesteppe.github.io/safeHavens/">safeHavens</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jakubnowosad.com/spData/" class="external-link">spData</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">23</span><span class="op">)</span></span>
<span><span class="va">planar_proj</span> <span class="op">&lt;-</span> <span class="st">'+proj=laea +lon_0=-421.171875 +lat_0=-16.8672134 +datum=WGS84 +units=m +no_defs'</span></span></code></pre></div>
<div class="section level2">
<h2 id="notes-about-safehavens">Notes about <code>safeHavens</code><a class="anchor" aria-label="anchor" href="#notes-about-safehavens"></a>
</h2>
<p>This package helps germplasm curators communicate areas of interest
to collection teams for them to collect new material for accession. It
provides seven different sampling approaches for curators to choose from
for each individual taxon they hope to process. It also allows for easy
integration into existing workflows and will put out the required
spatial data to share with collection teams.</p>
<p>Each of the approaches are based on standard practices in ecology,
and reflect very basic tenets of population genetics, and Toblers first
law of geography. They have various trade offs in terms of computational
and environmental complexity. The table below presents the currently
implemented sampling scheme and the user facing function associated with
them. In my mind the first four functions are really flavors of the same
process, one whereby we try and partition the species range into chunks
of similar sizes. However, as is often the case four things which seem
very similar to me may have enormously different results in
implementation. The fifth method <code>IBDBasedSample</code> is largely
in a class of it’s own, in lieu of using the <em>continuity</em> of
geographic space as it’s primary method, it focuses on the discontinuity
of space and using distance matrices and clustering to determine which
patches of range are more close to each than other patches. The impetus
behind this method is of course Sewall Wrights Isolation by Distance
(1943).</p>
<p>The <code>EcoregionBasedSample</code> may be the most commonly
encountered method in North America and in various formats is driving
two major germplasm banking projects in both the Midwest and
Southeastern United States, as well as at a high level, composing the
way that numerous native seed collection coordinators are structured in
the West. This method using environmental variation as an implicit guide
to targeting populations for seed collections, i.e. the different
ecoregions serve as a stratification agent. In broad strokes, the
general thinking is that these regions represent continuous transitions
in the environment faced by the species, and populations across these
ranges will be differently adapted to these environments. Given it’s
relative popularity in implementation, this function has more arguments
than it’s counterparts, which will be discussed below.</p>
<p>The final function <code>EnvironmentalBasedSample</code> is both the
most computationally expensive, and the most environmentally explicit.
This function will rely on a Species Distribution Model, generated via a
generalized linear model, supported by this package, to cluster
populations based on environmental variables related to their observed
distributions and the spatial configuration and distance between them.
On paper, this draws together all aspects of the above functions,
however no testing of this approach has been implemented. It will be
discussed below in depth.</p>
<table class="table">
<colgroup>
<col width="34%">
<col width="50%">
<col width="7%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th>Function</th>
<th>Description</th>
<th>Comp.</th>
<th>Envi.</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>GridBasedSample</code></td>
<td>Creates and merges <em>n</em> grids over area</td>
<td>L</td>
<td>L</td>
</tr>
<tr class="even">
<td><code>PointBasedSample</code></td>
<td>Creates points to make grids over area</td>
<td>L</td>
<td>L</td>
</tr>
<tr class="odd">
<td><code>EqualAreaSample</code></td>
<td>Breaks area into similar size pieces</td>
<td>L</td>
<td>L</td>
</tr>
<tr class="even">
<td><code>OpportunisticSample</code></td>
<td>Using PBS with existing records</td>
<td>L</td>
<td>L</td>
</tr>
<tr class="odd">
<td><code>IBDBasedSample</code></td>
<td>Breaks species range into clusters</td>
<td>H</td>
<td>M</td>
</tr>
<tr class="even">
<td><code>EcoregionBasedSample</code></td>
<td>Using existing ecoregions to sample</td>
<td>L</td>
<td>H</td>
</tr>
<tr class="odd">
<td><code>EnvironmentalBasedSample</code></td>
<td>Uses correlations from SDM to sample</td>
<td>H</td>
<td>H</td>
</tr>
</tbody>
</table>
<p>Note in this table ‘Comp.’ and ‘Envi.’ refer to computational and
environmental complexity respectively, and range from low (L) through
medium to high.</p>
</div>
<div class="section level2">
<h2 id="general-notes-about-this-vignette">General notes about this vignette<a class="anchor" aria-label="anchor" href="#general-notes-about-this-vignette"></a>
</h2>
<p>This package is strongly focused on plants, no disrespect to animals,
they just never occurred to me during development. However, to make it
up to animal people, we will use a Sloth, which I think is <a href="https://en.wikipedia.org/wiki/Brown-throated_sloth" class="external-link"><em>Bradypus
variegatus</em></a> it’s both a maniacally and mischievous looking
little thing. Beyond looking at the inspiration for most Jim Henson
puppets above, we will treat <em>Bradypus</em> more like a plant species
when we discuss these sampling schemes - that is we will assume we are
focused on organisms which seldom move great distances in dispersal
processes.</p>
<p>We can access some data on <em>Bradypus</em> from the
<code>dismo</code> package - presumably short for ‘<em>Dis</em>tribution
<em>Mo</em>delling’, which was created by Robert Hijman and others. We
will use a couple other <code>dismo</code> functions in this package,
and we will utilize some spatial data from it, It’s a good package to be
familiar with. If you want to read more about <code>dismo</code> and
distribution modelling in general here is an awesome bookdown resource
written by <a href="https://rspatial.org/raster/sdm/" class="external-link">Hijman and
Elith</a> - aspects of this vignette are definitely based on it. We will
use Species Distribution Models (SDMs) as the input variable to many of
the arguments in this function - don’t get caught up in the details of
making them. These days you can get good results out of essentially
entirely automated pipelines, we’ll have the truncated process outlined
here in a chunk, but I honestly argue you should ignore this section the
first few times you read this document, and go back for the details
(discussed in the link above) only if you decide to pursue the route of
<code>EnvironmentalBasedSample</code>. I may be too optimistic in
thinking that any one of these schemes will give adequate results for
sample design, but some may be better for certain species and
projects.</p>
<p>Future users will need to obtain their own occurrence records for
using with this package. The r package <code>rbgif</code> is a fantastic
way to do this, a well documented article linking to several vignettes
for the package is <a href="https://docs.ropensci.org/rgbif/articles/rgbif.html" class="external-link">here</a>.</p>
</div>
<div class="section level2">
<h2 id="species-distribution-modelling-skip-me-your-first-few-read-throughs">Species Distribution Modelling (skip me your first few read
throughs?!)<a class="anchor" aria-label="anchor" href="#species-distribution-modelling-skip-me-your-first-few-read-throughs"></a>
</h2>
<p>If you are interested in visualizing what a sampling scheme under
<code>safeHavens</code> most complex function
<code>EnvironmentalBasedSample</code> requires, you can explore this
section to understand the costs required to achieve this process. It
goes on for a while, so I almost recommend checking this section last.
In the meantime, if you still want to see the results from
<code>EnvironmentalBasedSample</code> compared to the other functions,
you can load the results from disk, they are distributed with the
package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"dismo"</span><span class="op">)</span>, <span class="st">'ex'</span>, <span class="st">'bradypus.csv'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lon'</span>, <span class="st">'lat'</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">x</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lon'</span>, <span class="st">'lat'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span></span>
<span>  path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"dismo"</span><span class="op">)</span>, <span class="st">'ex'</span><span class="op">)</span>, </span>
<span>  pattern <span class="op">=</span> <span class="st">'grd'</span>,  full.names<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span> <span class="co"># import the independent variables</span></span></code></pre></div>
<p>The goal of most SDM’s is to create a model which most accurately
predicts where a species will be located in environmental space, and
hence geographic space. The goal of these models are to understand the
degree, and direction, to which various environmental features correlate
with a species observed range. Accordingly, they are not optimized for
use in making the typical decisions associated with species distribution
models, i.e. conservation area planning. Rather the models supported in
this package are solely focused on estimating the <em>effects</em> of
various environmental parameters on the species distribution.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/elasticSDM.html">elasticSDM</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">x</span>, predictors <span class="op">=</span> <span class="va">predictors</span>, quantile_v <span class="op">=</span> <span class="fl">0.025</span>,</span>
<span>  planar_proj <span class="op">=</span> <span class="va">planar_proj</span><span class="op">)</span></span></code></pre></div>
<p>We use the <code>caret</code> package to help out with our
<code>glmnet</code> modelling, it’s unnecessary, but it provides output
which is very easy to explore and interact with. While much of
<code>caret</code> functionality has been improved on in
<code>tidymodels</code> and associated packages by Max Kuhn (also the
lead <code>caret</code> author), <code>caret</code> is pretty stable and
will serve our purposes fine. What makes an elastic net model
interesting is that it is able to bridge the worlds of lasso and ridge
regression by blending the alpha parameter. Lasso has an alpha of 0,
while Ridge has an alpha of 1. Lasso regression will perform automated
variable selection, and can actually drop (or ‘shrink’) them from a
model, while Ridge regression will keep all variables and if correlated
features are present give some contributions to each of them. An elastic
net blends this propensity to drop or retain variables whenever it is
used. <code>caret</code> will test a range of alphas to accomplish
this.</p>
<p>Note that by using this we don’t exactly get a feel for which
variable is really correlated with a an event, but we do at least get a
sense of how a set of variables affects the range. Infer from this at
your own risk! Inference from SDM’s is something I do not recommend
except in the most special of circumstances anyways.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdModel</span><span class="op">$</span><span class="va">CVStructure</span></span></code></pre></div>
<p>Here we can see how the elastic net decided which is the top model.
We used Accuracy rather than Kappa as the main criterion for model
selection.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdModel</span><span class="op">$</span><span class="va">ConfusionMatrix</span></span></code></pre></div>
<p>Here we can see how our selected model works on predicting the state
of test data. Note these accuracy results are slightly higher than those
from the CV folds. This is not a bug, CV folds are testing on their own
holdouts, while this is a brand new set of holdouts. The main reason the
confusion matrix results are likely to be higher is due to spatial
auto-correlation which are not address in a typical ‘random split’ of
test and train data. In order to minimize the effects of
spatial-autocorrelation on our model we use <code>CAST</code> under the
hood which allows for spatially informed cross validation.</p>
<p>Consider the output from CVStructure to be a bit more realistic.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sdModel</span><span class="op">$</span><span class="va">RasterPredictions</span><span class="op">)</span></span></code></pre></div>
<p>SDM’s produce surfaces which display the probability of suitable
habitat across a landscape. Many people want a binary prediction surface
from them, i.e. <em>is it more or less probable that suitable habitat
for this taxon exists in this particular location (grid cell)?</em>.
Going from a continuous probability surface to a binary surface loses a
lot of information, but in many use cases is essential to reduce
computational complexity. If you are interested in the caveats
associated with this Frank Harrell has written extensively on the topic.
We will use binary surfaces for implementing our sampling procedures
across a species range. The function <code>PostProcessSDM</code> is used
for this purpose.</p>
<p>Historically, when assessing probability output 0.5 probability was
used as a threshold, probabilities beneath if being considered ‘Not
suitable’, while probabilities above are classified as ‘Suitable’. This
works well for many use cases, but I argue that thresholding is outside
the domain of statistics and in the realm of practice. My motto for
implementing models, is a slight elaboration of George Box’s aphorism,
“<em>All models are wrong, some are useful - how do you want to be
wrong?</em>”. Our goal of sampling for germplasm conservation is to
maximize the representation of allelic diversity across the range of a
species. In order to do this, we need a good understanding of what the
species actual range is, hence I am more happy to predict the species
<em>is</em> present where it is not, than to predict it is absent where
it actually grows. Hence my preferred thresholding statistic is
<em>Sensitivity</em>, over any metric which weighs false predicted
presences. This argument is free to vary and supports any of the
threshold values calculated by <code><a href="https://rdrr.io/pkg/dismo/man/threshold.html" class="external-link">dismo::threshold</a></code>, explore it
to better understand it’s options.</p>
<p>Until now, you may be wondering why the function which achieves this
is named <code>PostProcessSDM</code> rather <code>ThresholdSDM</code>,
the reason for this perceived discontinuity is that the function does
another process in it’s second portion. Using all initial occurrence
data, both the sets that went into our training and test data for
developing the statistical model, we create ‘buffers’ around these
points to ensure that none of the known occurrence points are ‘missing’
from the output binary map. This is a two edged sword, where we are
again address the notion of dispersal limitation, and realize that not
all suitable habitat is occupied habitat.</p>
<p>What the <code>PostProcessSDM</code> function does is it again
creates cross validation folds, and selects all of our training data. In
each fold if then calculates the distance from each occurrence point to
it’s nearest neighbor. We then summarize these distances and can
understand the distribution of distances as a quantile. We use a
selected quantile, to then serve as a buffer. Area with predicted
suitable habitat outside of this buffer become ‘cut off’ (or masked)
from the binary raster map, and areas within buffer distance from known
occurrences which are currently masked are reassigned as probabilities.
The theory behind this process in underdeveloped and nascent, it does
come down to the gut of an analyst. With the <em>Bradypus</em> data set
I use 0.25 as the quantile, which is saying “Neighbors are generally
100km apart, I am happy with the risk of saying that 25km within each
occurrence is <em>occupied</em> suitable habitat”. Increasing this value
to say 1.0 will mean that no suitable habitat is removed, decreasing it
makes maps more conservative. The cost with increasing the distances
greatly is that the sampling methods may then puts grids in many areas
without populations to collect from.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">threshold_rasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PostProcessSDM.html">PostProcessSDM</a></span><span class="op">(</span></span>
<span>  rast_cont <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">RasterPredictions</span>, </span>
<span>  test <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">TestData</span>,</span>
<span>  planar_proj <span class="op">=</span> <span class="va">planar_proj</span>,</span>
<span>  thresh_metric <span class="op">=</span> <span class="st">'sensitivity'</span>, quant_amt <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p>We can compare the results of applying this function side by side
using the output from the function.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">threshold_rasts</span><span class="op">$</span><span class="va">FinalRasters</span><span class="op">)</span></span></code></pre></div>
<p><code>glmnet</code> is used for three main reasons, 1) it gives
directional coefficients and so we have a feel for how each 1 unit
increase in an independent variable predicts the response, In my mind
this is a big improvement over ‘Variable Importance Factors’ where we
just know that certain variables contributed more to the model than
others.<br>
2) It maintains some degree of automated selection reducing the work an
analyst needs to do, i.e. you can process many species without spending
too much time on any single one.<br>
3) <code>glmnet</code> actually re-scales all variables before model
generation, which I suppose can be implemented with other models, we
will use the same re-scaling that <code>glmnet</code> does to transform
our independent variables in the raster stack and then multiply them by
their beta-coefficients.<br>
In this way our raster stack becomes representative of our model, we can
then use these values as the basis for hierarchical cluster later
on.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CREATE A COPY OF THE RASTER PREDICTORS WHERE WE HAVE </span></span>
<span><span class="co"># STANDARDIZED EACH VARIABLE - SO IT IS EQUIVALENT TO THE INPUT TO THE GLMNET</span></span>
<span><span class="co"># FUNCTION, AND THEN MULTIPLIED IT BY IT'S BETA COEFFICIENT FROM THE FIT MODEL</span></span>
<span><span class="co"># we will also write out the beta coefficients using writeSDMresults right after</span></span>
<span><span class="co"># this. </span></span>
<span></span>
<span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RescaleRasters.html">RescaleRasters</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">Model</span>,</span>
<span>  predictors <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">Predictors</span>, </span>
<span>  training_data <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">TrainData</span>, </span>
<span>  pred_mat <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">PredictMatrix</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">RescaledPredictors</span><span class="op">)</span></span></code></pre></div>
<p>We can see that the variables are ‘close’ to being on the same scale,
this will work in a clustering algorithm. If any of the layers are all
the same color (maybe yellow?) that means they have no variance, that’s
a term that was shrunk from the model. It will be dealt with internally
in a future function. The scales of the variables are not exact, because
they are weighed by their coefficients in the model</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">rr</span><span class="op">$</span><span class="va">BetaCoefficients</span><span class="op">)</span></span></code></pre></div>
<p>We can also look at the coefficients for each variable.
<code>glmnet</code> returns the ‘untransformed’ variables, i.e. the
coefficients on the same scale as the input rasters, we calculate the BC
right afterwards.</p>
<p><code>safeHavens</code> generates all kinds of things as it runs
through the functions <code>elasticSDM</code>,
<code>PostProcessSDM</code>, and <code>RescaleRasters</code>. Given that
one of these sampling scheme may be followed for quite some time, I
think it is best practice to save many of these objects. Yes, they will
take up some storage space, but storage is virtually free these days
anyways. So why not write out all of the following items? I test write
them in a directory which exists for the project associated with the
creation of this R package, just save them somewhere and delete them
after this. These test files are tiny anyways.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bp</span> <span class="op">&lt;-</span> <span class="st">'~/Documents/assoRted/StrategizingGermplasmCollections'</span></span>
<span></span>
<span><span class="fu"><a href="../reference/writeSDMresults.html">writeSDMresults</a></span><span class="op">(</span></span>
<span>  cv_model <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">CVStructure</span>, </span>
<span>  pcnm <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">PCNM</span>, </span>
<span>  model <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">Model</span>, </span>
<span>  cm <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">ConfusionMatrix</span>, </span>
<span>  coef_tab <span class="op">=</span> <span class="va">rr</span><span class="op">$</span><span class="va">BetaCoefficients</span>, </span>
<span>  f_rasts <span class="op">=</span> <span class="va">threshold_rasts</span><span class="op">$</span><span class="va">FinalRasters</span>,</span>
<span>  thresh <span class="op">=</span> <span class="va">threshold_rasts</span><span class="op">$</span><span class="va">Threshold</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">bp</span>, <span class="st">'results'</span>, <span class="st">'SDM'</span><span class="op">)</span>, <span class="st">'Bradypus_test'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we can see that the files were placed here using this. </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">bp</span>, <span class="st">'results'</span>, <span class="st">'SDM'</span><span class="op">)</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span></span></code></pre></div>
<p>And there you have it, all the steps to make a species distribution
model - or rather to get the coefficients from a species distribution
model! We will play around with it as an example data set to compare our
buffered distance results to at the end.</p>
</div>
<div class="section level2">
<h2 id="alternative-to-sdm-just-buffer-start-reading-here-your-first-few-times">Alternative to SDM, just buffer! (start reading here your first few
times!)<a class="anchor" aria-label="anchor" href="#alternative-to-sdm-just-buffer-start-reading-here-your-first-few-times"></a>
</h2>
<p>Creating the SDMs is a whole process, and not all users may want to
create them. Here we provide an approach which will give us results we
can work with, and is computationally cheap.<br>
As a minimalist that would probably just use the
<code>IsolationByDistance</code> function, this would almost certainly
be the route I took to indentifying collection areas.</p>
<p>It relies on one input, the same occurrence data as above, and a
simple process - drawing a circle at a specific radius around each
observation point! Here we are showing the second of two major packages
which this package depends on, <code>sf</code>. <code>sf</code> relies
on simple feature geometries and is now the workhorse of most all vector
data analysis in R. It is very well documented and tested, if you are
unfamiliar with it you should consider it to be the <code>dplyr</code>
of the spatial data ecosystem in R. In this vignette I use
<code>::</code> notation so you can get an idea of where the functions
are coming from, and you’ll notice a lot of <code>sf::st_*</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">planar_proj</span> <span class="op">=</span></span>
<span>    <span class="st">'+proj=laea +lon_0=-421.171875 +lat_0=-16.8672134 +datum=WGS84 +units=m +no_defs'</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"dismo"</span><span class="op">)</span>, <span class="st">'ex'</span>, <span class="st">'bradypus.csv'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lon'</span>, <span class="st">'lat'</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">x</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lon'</span>, <span class="st">'lat'</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span></span>
<span><span class="va">x_buff</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">planar_proj</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="fl">125000</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># we are working in planar metric coordinates, we are</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># buffer by this many / 1000 kilometers. </span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">x_buff</span><span class="op">)</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Just%20Buffer%20it!-1.png" width="700"></p>
<p>Voila! That’s the whole process. Just play around with the distances
until you get something which looks OK. How do I define ‘OK’?.. A
feeling in the gut that your boots are tingling. Note that while the
buffered polygons may look a little nebulous now, we’ll have them on
maps with some more context in just a couple steps.</p>
</div>
<div class="section level2">
<h2 id="just-load-the-sdm">Just load the SDM!<a class="anchor" aria-label="anchor" href="#just-load-the-sdm"></a>
</h2>
<p>The package also has an SDM projection saved in the data we can just
load that too for a couple comparisions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdm</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"safeHavens"</span><span class="op">)</span>,  <span class="st">'extdata'</span>, <span class="st">'Bradypus_test.tif'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">sdm</span><span class="op">)</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="now-prep-some-data-for-visualizing-the-results">Now prep some data for visualizing the results<a class="anchor" aria-label="anchor" href="#now-prep-some-data-for-visualizing-the-results"></a>
</h2>
<p>While not necessary, we are going to add some context to our maps
which should help you interpret the results of the various functions
from the package. We will use the <code>spData</code> package which uses
naturalearth data for it’s <code>world</code> data and is suitable for
creating effective maps at a variety of resolutions.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x_extra_buff</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_buffer</a></span><span class="op">(</span><span class="va">x_buff</span>, <span class="fl">100000</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># add a buffer to 'frame' the maps</span></span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span></span>
<span></span>
<span><span class="va">americas</span> <span class="op">&lt;-</span> <span class="fu">spData</span><span class="fu">::</span><span class="va"><a href="https://jakubnowosad.com/spData/reference/world.html" class="external-link">world</a></span></span>
<span><span class="va">americas</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">st_crop</a></span><span class="op">(</span><span class="va">americas</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">x_extra_buff</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">name_long</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">#&gt; all geometries</span></span>
<span></span>
<span><span class="va">bb</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">x_extra_buff</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">americas</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    legend.position <span class="op">=</span> <span class="st">'none'</span>, </span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"aliceblue"</span><span class="op">)</span>, </span>
<span>    panel.grid.minor.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="fl">3</span>, linewidth  <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>, </span>
<span>    axis.ticks<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    plot.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"steelblue"</span><span class="op">)</span>,</span>
<span>    plot.margin<span class="op">=</span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>,<span class="st">"cm"</span><span class="op">)</span>,</span>
<span>    axis.ticks.length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0</span>, <span class="st">"pt"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bb</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">bb</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bb</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">bb</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span>, expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">x_extra_buff</span>, <span class="va">americas</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="running-the-various-sample-design-algorithms">Running the Various Sample Design Algorithms<a class="anchor" aria-label="anchor" href="#running-the-various-sample-design-algorithms"></a>
</h2>
<p>Now that we have some data which can represent species ranges, we can
run the various sampling approaches. The table in the introduction is
reproduced here for your leisure.</p>
<table class="table">
<colgroup>
<col width="34%">
<col width="50%">
<col width="7%">
<col width="7%">
</colgroup>
<thead><tr class="header">
<th>Function</th>
<th>Description</th>
<th>Comp.</th>
<th>Envi.</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>GridBasedSample</code></td>
<td>Creates and merges <em>n</em> grids over area</td>
<td>L</td>
<td>L</td>
</tr>
<tr class="even">
<td><code>PointBasedSample</code></td>
<td>Creates points to make pieces over area</td>
<td>L</td>
<td>L</td>
</tr>
<tr class="odd">
<td><code>EqualAreaSample</code></td>
<td>Breaks area into similar size pieces</td>
<td>L</td>
<td>L</td>
</tr>
<tr class="even">
<td><code>OpportunisticSample</code></td>
<td>Using PBS with existing records</td>
<td>L</td>
<td>L</td>
</tr>
<tr class="odd">
<td><code>IBDBasedSample</code></td>
<td>Breaks species range into clusters</td>
<td>H</td>
<td>M</td>
</tr>
<tr class="even">
<td><code>EcoregionBasedSample</code></td>
<td>Using existing ecoregions to sample</td>
<td>L</td>
<td>H</td>
</tr>
<tr class="odd">
<td><code>EnvironmentalBasedSample</code></td>
<td>Uses correlations from SDM to sample</td>
<td>H</td>
<td>H</td>
</tr>
</tbody>
</table>
<p><em>Note in this table ‘Comp.’ and ‘Envi.’ refer to computational and
environmental complexity respectively, and range from low (L) through
medium to high.</em></p>
<div class="section level4">
<h4 id="grid-based-and-point-based-sample">Grid Based and Point Based Sample<a class="anchor" aria-label="anchor" href="#grid-based-and-point-based-sample"></a>
</h4>
<p>Ecologists love grids. All of us are taught to love grids for
sampling. Grids are create for contiguous things. Species ranges are
often not contiguous; curators and analysts in our geographically great
ecosystems, e.g. the steppes, prairies, tundra, and taiga might find
these useful.<br>
Surprisingly coding the functions to create a grid based sample where
the most difficult of anything in this whole package. So why did I do
it, you ask? Because I too was trained tounequivocally love grids, I
also was already loathe to hear the question after a talk <em>“Why
didn’t you code grids? I love grids? I don’t think these comparisons are
complete until we see grids. We gave you <em>hors d’oeuvres</em> and you
gave us shit…”</em></p>
<p>You can look at the output below to see why grids are not great for
<em>this</em> type of problem.</p>
<p>The first step in grid sampling is determining an OK number of grids
to try and draw as a starting point, if we want 20 collections we will
need more than 20 grids, because several will be merged into the larger
ones. Using the aspect ratio of a simple bounding box around the area
will be analysing, the function will determine a default number of grids
(‘Original’) for testing. Using these defaults it will create a few
other sets of grids as well, by either removing one of two grids per
direction. Theoretically you could automate grid selection by comparing
the number of grids and the minimization of variance. To be safe I
wouldn’t consider configurations which generate less than 25 of these
initial grids.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TestGridSizes.html">TestGridSizes</a></span><span class="op">(</span><span class="va">x_buff</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">tgs</span><span class="op">)</span></span>
<span><span class="co">#&gt;       Name Grids  Variance GridNOx GridNOy</span></span>
<span><span class="co">#&gt; 1 Smallest    34  599.9513       8       6</span></span>
<span><span class="co">#&gt; 2  Smaller    28  813.2043       7       5</span></span>
<span><span class="co">#&gt; 3 Original    24  862.5458       6       4</span></span>
<span><span class="co">#&gt; 4   Larger    18  681.7667       5       3</span></span>
<span><span class="co">#&gt; 5  Largest    13 1182.8457       4       2</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tgs</span><span class="op">$</span><span class="va">Grids</span>, <span class="va">tgs</span><span class="op">$</span><span class="va">Variance</span>, xlab <span class="op">=</span> <span class="st">'Grid Number'</span>, ylab <span class="op">=</span> <span class="st">'Variance'</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'Number of grids and areas overlapping species range'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/text.html" class="external-link">text</a></span><span class="op">(</span><span class="va">tgs</span><span class="op">$</span><span class="va">Grids</span>, <span class="va">tgs</span><span class="op">$</span><span class="va">Variance</span> <span class="op">+</span> <span class="fl">25</span>, labels<span class="op">=</span><span class="va">tgs</span><span class="op">$</span><span class="va">Name</span>, cex<span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="fl">20</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="fl">25</span>, col<span class="op">=</span><span class="st">"orange"</span><span class="op">)</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Test%20Grid%20Sizes-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tgs</span> <span class="op">&lt;-</span> <span class="va">tgs</span><span class="op">[</span><span class="va">tgs</span><span class="op">$</span><span class="va">Name</span><span class="op">==</span><span class="st">'Smaller'</span>,<span class="op">]</span></span></code></pre></div>
<p>Essentially we need more than 20 grids, but realistically using more
than 25 grids - depending on the complexity of the species range - tends
to be an effective floor. In the table and plot above I opt for using
the ‘Smaller’ option, with 28 grids generated by prompting
<code><a href="https://r-spatial.github.io/sf/reference/st_make_grid.html" class="external-link">sf::st_make_grid</a></code> with 7 grids in the x direction and 5 in
the y direction. You can <em>kind of</em> think about this like an elbow
plot, but the samples are so few you won’t get the characteristic
shape.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid_buff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GridBasedSample.html">GridBasedSample</a></span><span class="op">(</span><span class="va">x_buff</span>, <span class="va">planar_proj</span>, gridDimensions <span class="op">=</span> <span class="va">tgs</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">gbs.p</span> <span class="op">&lt;-</span> <span class="va">map</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">grid_buff</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span> <span class="co"># geom_sf_label(data = grid_buff, aes(label = Assigned), alpha = 0.4) +  # on your computer, doesnt work at vignette size</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Grids'</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gbs.p</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Grid%20Based%20Samples-1.png" width="700"></p>
<p>With the grids we drew the pre-specified number of grids across the
species range, and then merged them together as required to get the
results. We will essentially do the inverse in this step, rather than
drawing boundaries - i.e. grid cells, we will draw points in the center
of grid cells. Essentially allowing the features to ‘grow’ a little more
naturally, to my thinking. I also think these results work a little bit
better on a fragmented range, their is still some odd clipping, where
minor portions of a section of range are assigned to a different grid,
but a little bit better.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PointBasedSample.html">PointBasedSample</a></span><span class="op">(</span><span class="va">x_buff</span><span class="op">)</span></span>
<span><span class="va">pbs.sf</span> <span class="op">&lt;-</span> <span class="va">pbs</span><span class="op">$</span><span class="va">Geometry</span></span>
<span></span>
<span><span class="va">pbs.p</span> <span class="op">&lt;-</span> <span class="va">map</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pbs.sf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="co">#  geom_sf_label(data = pbs.sf, aes(label = ID), alpha = 0.4) + </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Point'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">pbs.p</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Point%20Based%20Sample-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="equal-area-sample">Equal Area Sample<a class="anchor" aria-label="anchor" href="#equal-area-sample"></a>
</h4>
<p>Perhaps the simplest method which is offered in
<code>safeHavens</code> is <code>EqualAreaSample</code>. It simply
creates many points, <code>pts</code> defaults to 5000, within our
target polygon and then subjects them to k-means sampling where the
groups are specified by <code>n</code> our target number of collections.
The individual points then assigned to these groups have polygons which
‘take’ up all of the map space developed, and are intersected back to
the species range, and the area of each polygon is then measured. This
process will be ran a few times, defaulting to 100 <code>reps</code>,
and the set of polygons which was created during these reps with the
smallest variance in polygon size will be selected to be returned from
the function.</p>
<p>This differs from point based sampling in that the above instance, we
start with a few regulary spaced points to grow from, here we take a
step back and by using many points let the clusters grow themselves to
similar sizes.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eas</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EqualAreaSample.html">EqualAreaSample</a></span><span class="op">(</span><span class="va">x_buff</span>, planar_projection <span class="op">=</span> <span class="va">planar_proj</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Warning: did not converge in 10 iterations</span></span>
<span></span>
<span><span class="va">eas.p</span> <span class="op">&lt;-</span> <span class="va">map</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">eas</span><span class="op">$</span><span class="va">Geometry</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="co">#  geom_sf_label(data = eas.sf, aes(label = ID), alpha = 0.4) + </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Equal Area'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">eas.p</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Equal%20Area%20Sample-1.png" width="700">
In my mind the results look quite similar to point based sample.</p>
</div>
<div class="section level4">
<h4 id="opportunistic-sample">Opportunistic Sample<a class="anchor" aria-label="anchor" href="#opportunistic-sample"></a>
</h4>
<p>To be blunt, while there are many new players to the germplasm
conservation table (and we are thrilled to have you here!), many
existing collections have largely grown out of opportunity (which we are
still very happy about). Many Curators may be interested in how much
they can embed their existing collections into a sampling framework. The
function <code>OpportunisticSample</code> makes a few very minor
modifications to the point based sample to try and maximize an existing
collection. It doesn’t always work exceptionally, especially when a
couple collections are very close to each other, but it may be a
beneficial tool in the belt. As we have observed, the three previous
sampling schemes end of with somewhat similar results - so we took used
the <code>PointBasedSample</code> as the framework we embedded this
function into it - it was also the easiest function to work this
into!</p>
<p>Essentially this combines the approach of point based sampling, but
forces that the clusters are based around the existing accessions. It
attempts to ‘center’ the existing collections within clusters, but this
can be nearly impossible for a variety of reasons.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exist_pts</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">x_buff</span>, size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># ^^ just randomly sampling 10 points in the species range</span></span>
<span>   <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="va">os</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/OpportunisticSample.html">OpportunisticSample</a></span><span class="op">(</span>polygon <span class="op">=</span> <span class="va">x_buff</span>, n <span class="op">=</span> <span class="fl">20</span>, collections <span class="op">=</span> <span class="va">exist_pts</span><span class="op">)</span></span>
<span></span>
<span><span class="va">os.p</span> <span class="op">&lt;-</span> <span class="va">map</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">os</span><span class="op">$</span><span class="va">Geometry</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="co">#  geom_sf_label(data = os.sf, aes(label = ID), alpha = 0.4) + </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">exist_pts</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Opportunistic'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span></span>
<span><span class="va">os.p</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Opportunistic%20Sample-1.png" width="700">
As you see here, the grids have been aligned around the points. This can
lead to some funky clusters, but <em>a bird in hand is worth two in the
bush.</em></p>
</div>
<div class="section level4">
<h4 id="isolation-by-distance-based-sample">Isolation by Distance Based Sample<a class="anchor" aria-label="anchor" href="#isolation-by-distance-based-sample"></a>
</h4>
<p>Isolation by Distance, and to a much lesser extent Toblers first law
of geography, are the fundamental ideas driving this package. While the
above sampling schemes are implicitly based around the former idea, the
latter is the most essential for germplasm conservation. This function
explicitly uses IBD to develop a sampling scheme, and does not obfuscate
it with any other parameters.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span> <span class="co"># note that for this process we need a raster rather than </span></span>
<span>  path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"dismo"</span><span class="op">)</span>, <span class="st">'ex'</span><span class="op">)</span>, <span class="co"># vector data to accomplish</span></span>
<span>  pattern <span class="op">=</span> <span class="st">'grd'</span>,  full.names<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span> <span class="co"># this we will 'rasterize' the vector using terra</span></span>
<span><span class="va">predictors</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span> <span class="co"># this can also be done using 'fasterize'. Whenever</span></span>
<span><span class="co"># we rasterize a product, we will need to provide a template raster that our vector</span></span>
<span><span class="co"># will inherit the cell size, coordinate system, etc. from </span></span>
<span></span>
<span><span class="va">x_buff.sf</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="va">x_buff</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Range <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># and here we specify the field/column with our variable we want to become an attribute of our raster</span></span>
<span><span class="va">v</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span><span class="va">x_buff.sf</span>, <span class="va">predictors</span>, field <span class="op">=</span> <span class="st">'Range'</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># now we run the function demanding 20 areas to make accessions from, </span></span>
<span><span class="va">ibdbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/IBDBasedSample.html">IBDBasedSample</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">v</span>, n <span class="op">=</span> <span class="fl">20</span>, fixedClusters <span class="op">=</span> <span class="cn">TRUE</span>, template <span class="op">=</span> <span class="va">predictors</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ibdbs.p</span> <span class="op">&lt;-</span> <span class="va">map</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ibdbs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span><span class="co">#  geom_sf_label(data = os.sf, aes(label = ID), alpha = 0.4) + </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'IBD'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">ibdbs.p</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Isolatation%20by%20Distance%20Example-1.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">predictors</span>, <span class="va">files</span>, <span class="va">v</span>, <span class="va">x_buff.sf</span>, <span class="va">exist_pts</span>, <span class="va">os</span><span class="op">)</span></span></code></pre></div>
<p>Because these data were processed from a raster, they have these
sharp edges, representing raster tiles. However, it should immediately
be evident that the borders of the clusters are more natural looking
than in the previous (and future) sampling schemes.</p>
</div>
<div class="section level4">
<h4 id="ecoregion-based-sample">Ecoregion Based Sample<a class="anchor" aria-label="anchor" href="#ecoregion-based-sample"></a>
</h4>
<p>As mentioned this is by far the most commonly implemented method for
guiding native seed collection. However, I am not sure exactly how
practitioners all implement it, and whether the formats of application
are consistent among practitioners! For these reasons a few different
sets of options are supported for a user.</p>
<p>For general usage, two parameters are always required <code>x</code>
which is the species range as an sf object, and <code>ecoregions</code>,
the sf object containing the ecoregions of interest. The
<code>ecoregions</code> file does not need to be subset to the range of
<code>x</code> quite yet - the function will take care of that.
Additional arguments to the function include as usual <code>n</code> to
specify how many accession we are looking for in our collection. Two
additional arguments relate to whether we are using Omernik Level 4
ecoregions data or ecoregions (or biogeographic regions) from another
source. These are <code>OmernikEPA</code>, and
<code>ecoregion_col</code>, if you are using the official EPA release of
ecoregions then both of these are optional, however if you are not using
the EPA product than both <em>should</em> be supplied - but only the
<code>ecoregion_col</code> argument is totally necessary. This column
should contain unique names for the highest resolution level ecoregion
you want to use from the data set, for many data sets, such as our
example we call ‘neo_eco’ this may be the only field with ecolevel
information!</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neo_eco</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"safeHavens"</span><span class="op">)</span>, <span class="st">'extdata'</span>, <span class="st">'NeoTropicsEcoregions.gpkg'</span><span class="op">)</span>, </span>
<span>  quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">geom</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">neo_eco</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">11</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 6 features and 4 fields</span></span>
<span><span class="co">#&gt; Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: -103.0432 ymin: -31.25308 xmax: -34.79344 ymax: 26.91751</span></span>
<span><span class="co">#&gt; Geodetic CRS:  WGS 84</span></span>
<span><span class="co">#&gt;                  Provincias      Region      Dominio</span></span>
<span><span class="co">#&gt; 1 Araucaria Forest province Neotropical       Parana</span></span>
<span><span class="co">#&gt; 2          Atacama province Neotropical         &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3         Atlantic province Neotropical       Parana</span></span>
<span><span class="co">#&gt; 4           Bahama province Neotropical         &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5     Balsas Basin province Neotropical Mesoamerican</span></span>
<span><span class="co">#&gt; 6         Caatinga province Neotropical      Chacoan</span></span>
<span><span class="co">#&gt;                        Subregion                       geometry</span></span>
<span><span class="co">#&gt; 1                        Chacoan MULTIPOLYGON (((-53.58012 -...</span></span>
<span><span class="co">#&gt; 2 South American Transition Zone MULTIPOLYGON (((-69.42981 -...</span></span>
<span><span class="co">#&gt; 3                        Chacoan MULTIPOLYGON (((-48.41217 -...</span></span>
<span><span class="co">#&gt; 4                      Antillean MULTIPOLYGON (((-77.58593 2...</span></span>
<span><span class="co">#&gt; 5                      Brazilian MULTIPOLYGON (((-97.37265 1...</span></span>
<span><span class="co">#&gt; 6                        Chacoan MULTIPOLYGON (((-35.56652 -...</span></span>
<span></span>
<span><span class="va">x_buff</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">x_buff</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">neo_eco</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ebs.sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EcoregionBasedSample.html">EcoregionBasedSample</a></span><span class="op">(</span><span class="va">x_buff</span>, <span class="va">neo_eco</span>, OmernikEPA <span class="op">=</span> <span class="cn">FALSE</span>, ecoregion_col <span class="op">=</span> <span class="st">'Provincias'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">#&gt; all geometries</span></span>
<span></span>
<span><span class="co"># for plotting let's crop it to the other objects</span></span>
<span><span class="va">ebs.sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crop.html" class="external-link">st_crop</a></span><span class="op">(</span><span class="va">ebs.sf</span>, <span class="va">bb</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">#&gt; all geometries</span></span>
<span></span>
<span><span class="va">ebs.p</span> <span class="op">&lt;-</span> <span class="va">map</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ebs.sf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Ecoregion'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">F</span><span class="op">)</span></span>
<span><span class="va">ebs.p</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Ecoregion%20Based%20Sample-1.png" width="700"></p>
<p>The data which are output by this function differ drastically than
the data output by all the other functions. It simply represents a count
of targeted accession by ecoregion. In this case each ecoregion should
contribute one collection. For some reason I am convinced this is a
product many people will prefer relative to the ‘post-processed’ object
which we will work on delivering in the code just beneath here.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neo_eco</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">neo_eco</span>, <span class="va">Provincias</span><span class="op">)</span></span>
<span><span class="va">step1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_difference</a></span><span class="op">(</span><span class="va">neo_eco</span>, <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">st_union</a></span><span class="op">(</span><span class="va">x_buff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">step1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">intersects</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">ebs.sf</span>,<span class="va">neo_eco</span> <span class="op">)</span></span>
<span></span>
<span><span class="va">areas</span> <span class="op">&lt;-</span> <span class="fu">st_erase</span><span class="op">(</span><span class="va">ebs.sf</span>, <span class="va">x_buff</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">intersects</span><span class="op">)</span></span>
<span></span>
<span><span class="va">obby</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">neo_eco</span>, <span class="va">ebs.sf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">obby</span><span class="op">)</span></span>
<span></span>
<span><span class="va">map</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">areas</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Ecoregion Sample (Largest)'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="environmental-based-sample">Environmental Based Sample<a class="anchor" aria-label="anchor" href="#environmental-based-sample"></a>
</h4>
<p>The environmental based sample can only be conducted if you have the
species distribution model data. Included in the data directory of the
folder are all of the objects required to run this example for the
species. We will load them here.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sdModel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"safeHavens"</span><span class="op">)</span>, <span class="st">'extdata'</span>,  <span class="st">'sdModel.rds'</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">sdModel</span><span class="op">$</span><span class="va">Predictors</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span>package<span class="op">=</span><span class="st">"safeHavens"</span><span class="op">)</span>, <span class="st">'extdata'</span>, <span class="st">'Predictors.tif'</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Once these data are loaded into R, we will scale the rasters (using
<code>RescaleRasters</code>) which will serve as surfaces to predict
from (this is also done above!), then we will run the algorithm
(<code>EnvironmentalBasedSample</code>). However, before we run the
algorithm we will need to create a directory (also called a folder), on
our computers to save the results from the function
<code>EnvironmentalBasedSample</code>. Whereas earlier in this vignette
we showcased that the functions generated the species distribution
model, and us saving the results were a two stage process (e.g. to
create the SDM and associated products we used: <code>elasticSDM</code>,
<code>PostProcessSDM</code>, and <code>RescaleRasters</code>, before
finally saving relevant data with <code>writeSDMresults</code>), this
function both produces the product and writes out ancillary data at the
same time. This approach was chosen as this function is only writing out
four objects: 1) the groups as vector data, 2) and the groups as raster
data, 3) the k nearest neighbors (knn) model used to generate these
clusters, and 4) the confusion matrix associated with testing the knn
model.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RescaleRasters.html">RescaleRasters</a></span><span class="op">(</span> <span class="co"># you may have already done this!</span></span>
<span>  model <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">Model</span>,</span>
<span>  predictors <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">Predictors</span>, </span>
<span>  training_data <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">TrainData</span>, </span>
<span>  pred_mat <span class="op">=</span> <span class="va">sdModel</span><span class="op">$</span><span class="va">PredictMatrix</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create a directory to hold the results from EBS real quick. </span></span>
<span><span class="co"># we will default to placing it in your current working directory. </span></span>
<span><span class="co"># If you are a data management freak don't worry too much about this. </span></span>
<span><span class="co"># The code to remove the directory will be provided below. </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># this is where the folder is going to located IF YOU DON'T RUN the code below. </span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/safeHavens/safeHavens/vignettes"</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">'~'</span>, <span class="st">'Documents'</span><span class="op">)</span> <span class="co"># in my case I'll dump it in Documents real quick, this should work on </span></span>
<span><span class="co"># Linux and Mac, but I don't think Windows? </span></span>
<span><span class="co"># dir.create(file.path(p, 'safeHavens-Vignette')) # now create the directory. </span></span>
<span></span>
<span><span class="va">ENVIbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EnvironmentalBasedSample.html">EnvironmentalBasedSample</a></span><span class="op">(</span></span>
<span>  pred_rescale <span class="op">=</span> <span class="va">rr</span><span class="op">$</span><span class="va">RescaledPredictors</span>, </span>
<span>  write2disk <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>  path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">'safeHavens-Vignette'</span><span class="op">)</span>, <span class="co"># we are not writing, but showing how to provide argument</span></span>
<span>  taxon <span class="op">=</span> <span class="st">'Bradypus_test'</span>, </span>
<span>  f_rasts <span class="op">=</span> <span class="va">sdm</span>, n <span class="op">=</span> <span class="fl">20</span>, </span>
<span>  lyr <span class="op">=</span> <span class="st">'Supplemented'</span>,</span>
<span>  fixedClusters <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>  n_pts <span class="op">=</span> <span class="fl">500</span>, </span>
<span>  planar_projection <span class="op">=</span> <span class="va">planar_proj</span>,</span>
<span>  buffer_d <span class="op">=</span> <span class="fl">3</span>, prop_split <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(x, y)`</span></span>
<span><span class="co">#&gt; Warning in st_point_on_surface.sfc(st_geometry(x)): st_point_on_surface may not</span></span>
<span><span class="co">#&gt; give correct results for longitude/latitude data</span></span>
<span></span>
<span><span class="va">ENVIbs.p</span> <span class="op">&lt;-</span> <span class="va">map</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ENVIbs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">#geom_sf_label(data = ENVIbs, aes(label = ID), alpha = 0.4) + </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">'Environmental'</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Coordinate system already present. Adding new coordinate system, which will</span></span>
<span><span class="co">#&gt; replace the existing one.</span></span>
<span></span>
<span><span class="va">ENVIbs.p</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Environmental%20Based%20Sample-1.png" width="700"></p>
<p>The function <code>EnvironmentalBasedSample</code> can take any of
the three binary rasters created by <code>PostProcessSDM</code> as
arguments for the template. Here we showcase the different results from
using each of them.</p>
<p><img src="safeHavens_files/figure-html/Compare%20Environmental%20Based%20Samples-1.png" width="700"></p>
<p>These plots are able to showcase the difference in results depending
on which of the three input rasters are utilized. As with all of the
sampling schemes, results vary widely based on the spatial extents which
the functions are applied to. Using the SDM output which have undergone
thresholding results in the largest classified area. At first glance the
results may seem very different, but if you look at central america,
they are largely consistent, as they are near the Andes; large
differences do exist in the Amazon Basin, but even there some alignment
between the systems is evident. Accordingly, the surface used for a
species should match some evaluation criterion.</p>
<p>Using the threshold raster surface is a very good option if we do not
want to ‘miss’ too many areas, whereas the clipped and supplemented
options may be better suited for scenarios where we do not want to draw
up clusters, which lack any populations which can be collected from.</p>
</div>
</div>
<div class="section level2">
<h2 id="comparision-of-different-sampling-schemes">Comparision of different sampling schemes<a class="anchor" aria-label="anchor" href="#comparision-of-different-sampling-schemes"></a>
</h2>
<p>So, we’ve made got some maps for you to look at! They all look
relatively similar to me when plotted one after another, let’s plot them
all simultaneously and see if that’s still the case.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gbs.p</span> <span class="op">+</span> <span class="va">pbs.p</span> <span class="op">+</span> <span class="va">eas.p</span> <span class="op">+</span> <span class="va">os.p</span>  <span class="op">+</span>  <span class="va">ibdbs.p</span> <span class="op">+</span> <span class="va">ebs.p</span> <span class="op">+</span> <span class="va">ENVIbs.p</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="safeHavens_files/figure-html/Plot%20all%20Sampling%20Schemes%20together-1.png" width="700"></p>
<p>Again, the top three figures appear quite similar, with the
<code>Opportunistic</code> method only deviating slightly form them. In
my mind isolation by distance (IBD) show the biggest different, it seems
to have made the most <em>sense</em> of the naturally occurring
patchiness of the species range. Ecoregion SEEMS…. Environmental also
seems to partition the feature space quite well. Notably drawing a
couple clusters in the Pacfic lowlands and Northern Andes mountains.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Reed Benkendorf.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
