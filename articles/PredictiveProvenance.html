<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Predictive Provenance • safeHavens</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Predictive Provenance">
<meta name="description" content="Predictive Provenancing using Species Distribution Models.">
<meta property="og:description" content="Predictive Provenancing using Species Distribution Models.">
<meta property="og:image" content="https://sagesteppe.github.io/safeHavens/logo.png">
<!-- Google Search Console Verification --><meta name="google-site-verification" content="viUZcwXk_Fi5hsfdB7m6GgrFgGMJ-xVe1BcMTezGJII">
<!-- JSON-LD Structured Data for AI Crawlers --><script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  "name": "safeHavens",
  "applicationCategory": "Scientific Software",
  "operatingSystem": "Windows, macOS, Linux",
  "softwareVersion": "0.0.0.9000",
  "description": "R package providing seven sampling schemes for germplasm curators to prioritize field collection efforts for ex situ plant conservation, including species distribution modeling optimized for germplasm sampling.",
  "url": "https://sagesteppe.github.io/safeHavens/",
  "downloadUrl": "https://github.com/sagesteppe/safeHavens",
  "author": {
    "@type": "Person",
    "name": "Reed Benkendorf",
    "url": "https://github.com/sagesteppe"
  },
  "programmingLanguage": "R",
  "keywords": [
    "germplasm conservation",
    "ex situ conservation",
    "plant conservation",
    "sampling design",
    "species distribution model",
    "SDM",
    "biodiversity",
    "seed collection",
    "R package",
    "conservation biology"
  ],
  "inLanguage": "en-US",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "USD"
  }
}
</script><!-- Additional SEO Meta Tags --><meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large">
<meta name="keywords" content="germplasm conservation, ex situ conservation, plant conservation, sampling design, species distribution model, R package">
<meta name="author" content="Reed Benkendorf">
<link rel="canonical" href="https://sagesteppe.github.io/safeHavens/">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">safeHavens</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/sagesteppe/safeHavens/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Predictive Provenance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/sagesteppe/safeHavens/blob/main/vignettes/PredictiveProvenance.Rmd" class="external-link"><code>vignettes/PredictiveProvenance.Rmd</code></a></small>
      <div class="d-none name"><code>PredictiveProvenance.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>We have already shown that the beta-coefficients from species
distribution models can be used in hierarchical clustering to group a
species populations into clusters that experience more similar - and
relevant to their ecology - climate. While running
<code>EnvironmentalBasedSample</code> we focus on also optimizing the
species occupied range using moran eigenvector matrix surfaces (MEMs, or
PCNM). In this alternative approach we drop the PCNMs from the SDMs and
focus solely on environmental predictors, and work to identify clusters
in <strong>current</strong> environmental space, and then classify
<strong>future</strong> environmental (and geographic) space with these
cluster parameters. This gives us sets of areas with populations that
may be more pre-adapted to future conditions.</p>
<p>In addition to transferring the realized environmental clusters of
populations forward, we also identify novel climate spaces, using MESS
(Elith 2010), and hierarchical clustering. This results in us having
<em>n</em> identified clusters, and we can traverse the clustering
branches to determine which existing clusters are <em>most</em> similar
to novel clusters.</p>
<p>This is the sole workflow in <code>safeHavens</code> that seeks to
link current climates to future scenarios, and directly suggest how the
size of clusters may change, where they will shift to, and allow a
germplasm curator to identify relevant seed sources for predictive
provenancing. The approach employed here is adequate to guide
<em>current</em> collections, however decisions on what sources to use
at a particular restoration site are relatively well identified by tools
such as the <em>Seed Lot Selection Tool</em> in North America, and COSST
in South America.</p>
</div>
<div class="section level2">
<h2 id="analysis">Analysis<a class="anchor" aria-label="anchor" href="#analysis"></a>
</h2>
<p>This workstream leans heavily on the
<code>EnvironmentalBasedSample</code> workflow, and passes it’s final
objects off to <code>PolygonBasedSample</code> for completion. Please
review <code>Species Distribution Models</code> and
<code>Getting Started</code> before proceeding here.</p>
<div class="section level3">
<h3 id="data-prep">Data prep<a class="anchor" aria-label="anchor" href="#data-prep"></a>
</h3>
<p>This workflow will require the <code>geodata</code> package;
<code>geodata</code> is used for retrieving climate data from a variety
of sources as raster data. In this vignette we will use <a href="https://www.worldclim.org/" class="external-link">Worldclim</a>. For most
<code>safeHavens</code> users around the world this may be your ideal
source for climate data. <code>geodata</code> is developed and
maintained by Robert Hijman, similar to <code>terra</code>, and
<code>dismo</code>, which are doing a ton of heavy lifting internally on
our functions.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(safeHavens)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>terra <span class="dv">1</span>.<span class="fl">8.93</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(geodata)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>Linking to GEOS <span class="dv">3</span>.<span class="fl">12.1</span>, GDAL <span class="dv">3</span>.<span class="fl">8.4</span>, PROJ <span class="dv">9</span>.<span class="fl">4.0</span>; <span class="fu">sf_use_s2</span>() is <span class="cn">TRUE</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>Attaching package<span class="sc">:</span> <span class="st">'dplyr'</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>The following objects are masked from <span class="st">'package:terra'</span><span class="sc">:</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>    intersect, union</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>The following objects are masked from <span class="st">'package:stats'</span><span class="sc">:</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>    filter, lag</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>The following objects are masked from <span class="st">'package:base'</span><span class="sc">:</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>    intersect, setdiff, setequal, union</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>Attaching package<span class="sc">:</span> <span class="st">'tidyr'</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>The following object is masked from <span class="st">'package:terra'</span><span class="sc">:</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>    extract</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>Attaching package<span class="sc">:</span> <span class="st">'patchwork'</span></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>The following object is masked from <span class="st">'package:terra'</span><span class="sc">:</span></span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>    area</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">22</span>)</span></code></pre></div>
<p>For this example we will leverage data from GBIF, and shift our
geographic focus to the Colorado Plateau in the Southwestern USA. The
Colorado Plateau is predicted to experience some of the highest rates of
climate change on the planet, and is already an area with considerably
native seed development activities. For our focal species we will use
<em>Helianthella microcephala</em> for no other reason than that it
exists in relatively homogenous portions of the Colorado Plateau -
meaning we can download relatively coarse rasters for the vignettes, and
that it has a <em>stunning</em> inflorescence.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>cols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'decimalLatitude'</span>, <span class="st">'decimalLongitude'</span>, <span class="st">'dateIdentified'</span>, <span class="st">'species'</span>, <span class="st">'acceptedScientificName'</span>, <span class="st">'datasetName'</span>, </span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="st">'coordinateUncertaintyInMeters'</span>, <span class="st">'basisOfRecord'</span>, <span class="st">'institutionCode'</span>, <span class="st">'catalogNumber'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="do">## download species data using scientificName, can use keys and lookup tables for automating many taxa. </span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>hemi <span class="ot">&lt;-</span> rgbif<span class="sc">::</span><span class="fu">occ_search</span>(<span class="at">scientificName =</span> <span class="st">"Helianthella microcephala"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>hemi <span class="ot">&lt;-</span> hemi[[<span class="st">'data'</span>]][,cols]  <span class="sc">|&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>  <span class="fu">drop_na</span>(decimalLatitude, decimalLongitude) <span class="sc">|&gt;</span> <span class="co"># any missing coords need dropped. </span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>  <span class="fu">distinct</span>(decimalLatitude, decimalLongitude, <span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> <span class="co"># no dupes can be present</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>( <span class="st">'decimalLongitude'</span>, <span class="st">'decimalLatitude'</span>), <span class="at">crs =</span> <span class="dv">4326</span>, <span class="at">remove =</span> F) </span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>western_states <span class="ot">&lt;-</span> spData<span class="sc">::</span>us_states <span class="sc">|&gt;</span> <span class="do">## for making a quick basemap. </span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(NAME <span class="sc">%in%</span> </span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">'Utah'</span>, <span class="st">'Arizona'</span>, <span class="st">'Colorado'</span>, <span class="st">'New Mexico'</span>, <span class="st">'Wyoming'</span>, <span class="st">'Nevada'</span>, <span class="st">'Idaho'</span>, <span class="st">'California'</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(NAME, geometry) <span class="sc">|&gt;</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>bb <span class="ot">&lt;-</span> <span class="fu">st_bbox</span>(</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>    <span class="at">xmin =</span> <span class="sc">-</span><span class="dv">115</span>, </span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    <span class="at">xmax =</span> <span class="sc">-</span><span class="dv">105</span>, </span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>    <span class="at">ymax =</span> <span class="dv">43</span>, </span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>    <span class="at">ymin =</span> <span class="fl">33.5</span>),</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>    <span class="at">crs =</span> <span class="fu">st_crs</span>(<span class="dv">4326</span>)</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>    )</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>western_states <span class="ot">&lt;-</span> <span class="fu">st_crop</span>(western_states, bb)</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>Warning<span class="sc">:</span> attribute variables are assumed to be spatially constant throughout</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>all geometries</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>bmap <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> western_states) <span class="sc">+</span> </span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> hemi) <span class="sc">+</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>    <span class="fu">coord_sf</span>(</span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>        <span class="at">xlim =</span> <span class="fu">c</span>(bb[[<span class="st">'xmin'</span>]], bb[[<span class="st">'xmax'</span>]]), </span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>        <span class="at">ylim =</span> <span class="fu">c</span>(bb[[<span class="st">'ymin'</span>]], bb[[<span class="st">'ymax'</span>]])</span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a>        )  <span class="sc">+</span></span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a>      <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a>      <span class="at">axis.text.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a>      <span class="at">axis.ticks.x=</span><span class="fu">element_blank</span>()</span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a>      )</span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a>bmap <span class="sc">+</span></span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Helianthella microcephala occurrence records'</span>)</span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/Download%20species%20occurrence%20data-1.png" class="r-plt" alt="" width="700"></p>
<p>We will download worldclim data using <code>geodata</code> the
results from <code>worldclim_global</code> should be what we loaded from
<code>dismo</code> in the various sloth examples.<br>
For our future scenario we will use the <a href="https://wcrp-cmip.org/cmip-phases/cmip6/" class="external-link">CMIP6</a> modelled
future climate data for the 2041-2060 time window. We will download the
coarse 2.5 minute, ca ~70km at equator, resolution data. Do note that
the source also includes a ~ 1km at equator resolution data set (30
seconds), but this would take too long for the vignette.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download WorldClim bioclim at ~10 km</span></span>
<span><span class="va">bio_current</span> <span class="op">&lt;-</span> <span class="fu">worldclim_global</span><span class="op">(</span>var<span class="op">=</span><span class="st">"bioc"</span>, res<span class="op">=</span><span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="va">bio_future</span> <span class="op">&lt;-</span> <span class="fu">cmip6_world</span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="st">"CNRM-CM6-1"</span>, <span class="co">## modelling method</span></span>
<span>  ssp   <span class="op">=</span> <span class="st">"245"</span>, <span class="co">## "Middle of the Road" scenario</span></span>
<span>  time  <span class="op">=</span> <span class="st">"2041-2060"</span>, <span class="co"># time period</span></span>
<span>  var   <span class="op">=</span> <span class="st">"bioc"</span>, <span class="co"># just use the bioclim variables</span></span>
<span>  res   <span class="op">=</span> <span class="fl">2.5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Crop to domain - use a large BB to accomodate range shift</span></span>
<span><span class="co"># under future time points. </span></span>
<span><span class="co"># but going too large will dilute the absence records</span></span>
<span><span class="va">bbox</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/ext.html" class="external-link">ext</a></span><span class="op">(</span><span class="va">bb</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bio_current</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bio_current</span>, <span class="va">bbox</span><span class="op">)</span></span>
<span><span class="va">bio_future</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/crop.html" class="external-link">crop</a></span><span class="op">(</span><span class="va">bio_future</span>, <span class="va">bbox</span><span class="op">)</span></span></code></pre></div>
<p><code>safeHavens</code> does not offer explicit functionality to
rename / align the naming of raster surfaces. However, the modelling
process requires that both current and future raster products have
perfectly matching raster names. The chunk below shows how we will
standardize the names by extracting the bioclim variable number, at the
end of the name, and pad ‘bio_’ back onto the front of it with a leading
zero so we have: ‘bio_01’ instead of ‘bio_1’. A minor variation of this
should work for most data sources, after customizing the
<code>gsub</code> to erase earlier portions of the file name.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>simplify_names <span class="ot">&lt;-</span> <span class="cf">function</span>(x){</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    <span class="fu">paste0</span>(<span class="st">'bio_'</span>, <span class="fu">sprintf</span>(<span class="st">"%02d"</span>, <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">'</span><span class="sc">\\</span><span class="st">D+'</span>,<span class="st">''</span>, <span class="fu">names</span>(x)))))</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">names</span>(bio_current) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">'^.*5m_'</span>, <span class="st">''</span>, <span class="fu">names</span>(bio_current))</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="fu">names</span>(bio_future) <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">'^.*2060_'</span>, <span class="st">''</span>, <span class="fu">names</span>(bio_future))</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="fu">names</span>(bio_current) <span class="ot">&lt;-</span> <span class="fu">simplify_names</span>(bio_current)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="fu">names</span>(bio_future) <span class="ot">&lt;-</span> <span class="fu">simplify_names</span>(bio_future)</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="co"># TRUE means all names match, and are in the same position. </span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="fu">all</span>(<span class="fu">names</span>(bio_current) <span class="sc">==</span> <span class="fu">names</span>(bio_future))</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>[<span class="dv">1</span>] <span class="cn">TRUE</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="do">## we will also drop some variables that are essentially identical in the study area</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>drops <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  <span class="st">'bio_05'</span> , <span class="st">'bio_02'</span>,</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>  <span class="st">'bio_11'</span>, <span class="st">'bio_12'</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>  ) </span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>bio_current <span class="ot">&lt;-</span> <span class="fu">subset</span>(bio_current, <span class="at">negate =</span> <span class="cn">TRUE</span>, drops)</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>bio_future <span class="ot">&lt;-</span> <span class="fu">subset</span>(bio_future, <span class="at">negate =</span> <span class="cn">TRUE</span>, drops)</span></code></pre></div>
<p>If you are following the vignette along locally and decided to
<code>plot(bio_current)</code> and <code>plot(bio_future)</code> you
would find that they look very similar. While the plots look very
similar, when showing one raster stack after another, we can diff the
two products to see where the largest changes in geographic space will
occur.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">difference</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bio_current</span> <span class="op">-</span> <span class="va">bio_future</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">difference</span><span class="op">)</span></span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/diff%20the%20raster%20layers%20to%20show%20areas%20of%20difference-1.png" class="r-plt" alt="" width="700"></p>
<p>We see that variables have inconsistences in <em>where</em> they will
change, and to what extent they will change. This mismatch of conditions
will almost certainly lead to <em>novel</em> climate conditions - unique
combinations not yet known to this species. This will be handled using
MESS surfaces and a second stage clustering approach in the
function.</p>
</div>
<div class="section level3">
<h3 id="analytical-workstream">Analytical workstream<a class="anchor" aria-label="anchor" href="#analytical-workstream"></a>
</h3>
<p>The workflow for predictive provenance is quite similar to the
<code>EnvironmentalBasedSample</code> workflow, relying on many of the
same internal helpers, and user facing functions. Note that when using
<code>elasticSDM</code> we need to specify the flag
<code>pcnm = FALSE</code> to bypass fitting a model with PCNM surfaces -
their is no analog for these under future scenarios so they must be
dropped.</p>
</div>
<div class="section level3">
<h3 id="fit-sdm-and-rescale-raster-surfaces">Fit SDM and rescale raster surfaces<a class="anchor" aria-label="anchor" href="#fit-sdm-and-rescale-raster-surfaces"></a>
</h3>
<p>The starting point for this analysis is again fitting a quick SDM for
our species.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="do">## note we subset to just the geometries for the prediction records. </span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co"># this is because we feed in all columns to the elastic net model internally. </span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>hemi <span class="ot">&lt;-</span> <span class="fu">select</span>(hemi, geometry) </span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co"># as always verify our coordinate reference systems (crs) match. </span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="fu">st_crs</span>(bio_current) <span class="sc">==</span> <span class="fu">st_crs</span>(hemi) </span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>[<span class="dv">1</span>] <span class="cn">TRUE</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a><span class="co"># and fit the elasticnet model </span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>eSDM_model <span class="ot">&lt;-</span> <span class="fu">elasticSDM</span>(</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>    <span class="at">x =</span> hemi, </span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>    <span class="at">predictors =</span> bio_current, </span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>    <span class="at">planar_projection =</span> <span class="dv">5070</span>, </span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    <span class="at">PCNM =</span> <span class="cn">FALSE</span> <span class="do">## set to FALSE for this workstream!!!!!</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>    )</span></code></pre></div>
<p>We will use the eSDM_model function for this workstream, however is
is essential that PCNM is set to FALSE. There is no way to forecast of
predict PCNM to future scenarios, so we cannot fit models with it.</p>
<p>If a warning is emitted here it is likely due to collinearity in the
bioclim variables. Rather than using <code>eDist</code> from sdm for
generating background points we will use the <code>eRandom</code> method
instead.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>eSDM_model<span class="sc">$</span>ConfusionMatrix<span class="sc">$</span>byClass[</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">'Sensitivity'</span>, <span class="st">'Specificity'</span>, <span class="st">'Recall'</span>, <span class="st">'Balanced Accuracy'</span>)]</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>      Sensitivity       Specificity            Recall Balanced Accuracy </span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>        <span class="fl">1.0000000</span>         <span class="fl">0.6923077</span>         <span class="fl">1.0000000</span>         <span class="fl">0.8461538</span> </span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="fu">plot</span>(eSDM_model<span class="sc">$</span>RasterPredictions)</span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/current%20sdm%20threshold%20results-1.png" class="r-plt" alt="" width="700"></p>
<p>We can view some of the results for the model, it is OK, but would
benefit from using only a subset of the bioclim predictors to allow for
<code>eDist</code> sampling upstream. It is a bit too generoous with
classifying areas as being possible suitable habitat.</p>
<p>Using the beta-coefficients from the model we will rescale both the
current and future climate scenarios rasters.<br>
This will happen internally in the next function, but it is good to see
the different between the current and future scenarios to have an idea
of expectations for the final results.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bio_current_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RescaleRasters.html">RescaleRasters</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">eSDM_model</span><span class="op">$</span><span class="va">Model</span>, </span>
<span>    predictors <span class="op">=</span> <span class="va">eSDM_model</span><span class="op">$</span><span class="va">Predictors</span>,</span>
<span>    training_data <span class="op">=</span> <span class="va">eSDM_model</span><span class="op">$</span><span class="va">Train</span>,</span>
<span>    pred_mat <span class="op">=</span> <span class="va">eSDM_model</span><span class="op">$</span><span class="va">PredictMatrix</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bio_current_rs</span><span class="op">$</span><span class="va">RescaledPredictors</span><span class="op">)</span></span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/rescale%20rasters-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>bio_future_rs <span class="ot">&lt;-</span> <span class="fu">rescaleFuture</span>(</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  eSDM_model<span class="sc">$</span>Model, </span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  bio_future, </span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  eSDM_model<span class="sc">$</span>Predictors,</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="at">training_data =</span> eSDM_model<span class="sc">$</span>Train,</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="at">pred_mat =</span> eSDM_model<span class="sc">$</span>PredictMatrix</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>bio_future_rs</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>class       <span class="sc">:</span> SpatRaster </span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>size        <span class="sc">:</span> <span class="dv">228</span>, <span class="dv">240</span>, <span class="dv">8</span>  (nrow, ncol, nlyr)</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>resolution  <span class="sc">:</span> <span class="fl">0.04166667</span>, <span class="fl">0.04166667</span>  (x, y)</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>extent      <span class="sc">:</span> <span class="sc">-</span><span class="dv">115</span>, <span class="sc">-</span><span class="dv">105</span>, <span class="fl">33.5</span>, <span class="dv">43</span>  (xmin, xmax, ymin, ymax)</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>coord. ref. <span class="sc">:</span> lon<span class="sc">/</span>lat WGS <span class="dv">84</span> (EPSG<span class="sc">:</span><span class="dv">4326</span>) </span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="fu">source</span>(s)   <span class="sc">:</span> memory</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>names       <span class="sc">:</span>    bio_03,    bio_15,    bio_14,    bio_04,     bio_06,    bio_16, ... </span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>min values  <span class="sc">:</span> <span class="sc">-</span><span class="fl">8.757232</span>, <span class="sc">-</span><span class="fl">8.239257</span>, <span class="sc">-</span><span class="fl">5.973386</span>, <span class="sc">-</span><span class="fl">3.415114</span>, <span class="sc">-</span><span class="fl">0.7634497</span>, <span class="sc">-</span><span class="fl">5.263755</span>, ... </span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>max values  <span class="sc">:</span> <span class="fl">10.531289</span>, <span class="fl">14.357820</span>, <span class="fl">19.954478</span>,  <span class="fl">5.006051</span>,  <span class="fl">1.2668881</span>, <span class="fl">11.326773</span>, ... </span></code></pre></div>
<p>If any of the layers show as a single color, and 0, it means that
glmnet shrunk them from the model.</p>
<p>Similar to how we differenced the rasters at the two time points
above, we can take the absolute difference of the relevant raster layers
to see where the largest changes will be.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">difference_rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">bio_current_rs</span><span class="op">$</span><span class="va">RescaledPredictors</span> <span class="op">-</span> <span class="va">bio_future_rs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">difference_rs</span><span class="op">)</span></span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/rescaled%20raster%20difference-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level3">
<h3 id="cluster-surfaces">Cluster surfaces<a class="anchor" aria-label="anchor" href="#cluster-surfaces"></a>
</h3>
<p>Clusters can be identified using NbClust, allowing it to determine
the optimal <em>n</em> using the METHOD. To use NbClust, rather than
manually specifying <em>n</em>, the argument <code>fixedClusters</code>
needs to be set to FALSE. When using PostProcessSDM the same threshhold
metric should be used that will be applied to
<code>PredictiveProvenance</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>threshold_rasts <span class="ot">&lt;-</span> <span class="fu">PostProcessSDM</span>(</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="at">rast_cont =</span> eSDM_model<span class="sc">$</span>RasterPredictions, </span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="at">test =</span> eSDM_model<span class="sc">$</span>TestData,</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="at">train =</span> eSDM_model<span class="sc">$</span>TrainData,</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="at">planar_proj =</span> <span class="dv">5070</span>,</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="at">thresh_metric =</span> <span class="st">'equal_sens_spec'</span>, </span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>  <span class="at">quant_amt =</span> <span class="fl">0.25</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>  )</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="dv">1000</span> prediction points are sampled from the modeldomain</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>threshold_rasts<span class="sc">$</span>Threshold<span class="sc">$</span>equal_sens_spec</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.6195252</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>bmap <span class="sc">+</span> </span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> </span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  sf<span class="sc">::</span><span class="fu">st_as_sf</span>(</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">as.polygons</span>(</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>      threshold_rasts<span class="sc">$</span>FinalRasters[<span class="st">'Threshold'</span>])</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>      ), <span class="at">fill =</span> <span class="st">'cornsilk'</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>    ) <span class="sc">+</span> </span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> hemi) </span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a> [<span class="dv">1</span>m [<span class="dv">22</span>mCoordinate system already present.</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a> [<span class="dv">36</span>mℹ [<span class="dv">39</span>m Adding new coordinate system, which will replace the existing one.</span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/identify%20current%20clusters-1.png" class="r-plt" alt="" width="700"></p>
<p>We will make the EnvironmentalBasedSample to find a suitable number
of climate clusters at the current time period. When using EBS for
predictive provencing also set the coord_wt parameter to a small value.
This will remove the effect of the spatial clustering. Similar to PCNM,
we cannot know the distribution of actual populations in the future.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ENVIbs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/EnvironmentalBasedSample.html">EnvironmentalBasedSample</a></span><span class="op">(</span></span>
<span>  pred_rescale <span class="op">=</span> <span class="va">bio_current_rs</span><span class="op">$</span><span class="va">RescaledPredictors</span>, </span>
<span>  write2disk <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co"># we are not writing, but showing how to provide some arguments</span></span>
<span>  f_rasts <span class="op">=</span> <span class="va">threshold_rasts</span><span class="op">$</span><span class="va">FinalRasters</span>, </span>
<span>  coord_wt <span class="op">=</span> <span class="fl">0.001</span>, </span>
<span>  fixedClusters <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  lyr <span class="op">=</span> <span class="st">'Threshold'</span>,</span>
<span>  n_pts <span class="op">=</span> <span class="fl">500</span>, </span>
<span>  planar_proj <span class="op">=</span> <span class="st">"epsg:5070"</span>,</span>
<span>  buffer_d <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  prop_split <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  min.nc <span class="op">=</span> <span class="fl">5</span>, </span>
<span>  max.nc <span class="op">=</span> <span class="fl">15</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/EnvironmentalBasedSample-1.png" class="r-plt" alt="" width="700"></p>
<pre><code>*** : The Hubert index is a graphical method of determining the number of clusters.
                In the plot of Hubert index, we seek a significant knee that corresponds to a 
                significant increase of the value of the measure i.e the significant peak in Hubert
                index second differences plot. 
 </code></pre>
<p><img src="PredictiveProvenance_files/figure-html/EnvironmentalBasedSample-2.png" class="r-plt" alt="" width="700"></p>
<pre><code>*** : The D index is a graphical method of determining the number of clusters. 
                In the plot of D index, we seek a significant knee (the significant peak in Dindex
                second differences plot) that corresponds to a significant increase of the value of
                the measure. 
 
******************************************************************* 
* Among all indices:                                                
* 1 proposed 5 as the best number of clusters 
* 3 proposed 6 as the best number of clusters 
* 2 proposed 7 as the best number of clusters 
* 9 proposed 8 as the best number of clusters 
* 2 proposed 11 as the best number of clusters 
* 2 proposed 14 as the best number of clusters 
* 3 proposed 15 as the best number of clusters 

                   ***** Conclusion *****                            
 
* According to the majority rule, the best number of clusters is  8 
 
 
******************************************************************* 

bmap + 
  geom_sf(data = ENVIbs$Geometry, aes(fill = factor(ID))) + 
  geom_sf(data = hemi) + 
  theme(legend.position = 'bottom')
 [1m [22mCoordinate system already present.
 [36mℹ [39m Adding new coordinate system, which will replace the existing one.</code></pre>
<p><img src="PredictiveProvenance_files/figure-html/EnvironmentalBasedSample-3.png" class="r-plt" alt="" width="700"></p>
<p>We can apply the current clustering to the future scenario. This will
show us how and where the currently identified clusters would exist in
future geographic space. <code>ProjectClusters</code> is really the
whole heart of this workflow, it requires the outputs from
<code>elasticSDM</code>, <code>PostProcessSDM</code>, and
<code>EnvironmentalBasedSample</code>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>future_clusts <span class="ot">&lt;-</span> <span class="fu">projectClusters</span>(</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  <span class="at">eSDM_object =</span> eSDM_model, </span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="at">current_clusters =</span> ENVIbs,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="at">future_predictors =</span> bio_future,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="at">current_predictors =</span> bio_current,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  <span class="at">thresholds =</span> threshold_rasts<span class="sc">$</span>Threshold, </span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>  <span class="at">planar_proj =</span> <span class="st">"epsg:5070"</span>, </span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="at">thresh_metric =</span> <span class="st">'equal_sens_spec'</span>,</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>  <span class="at">n_sample_per_cluster =</span> <span class="dv">20</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>)</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>Clustering novel climate areas...</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>Warning<span class="sc">:</span> [spatSample] fewer cells returned than requested</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>Warning <span class="cf">in</span> <span class="fu">cluster_novel_areas</span>(<span class="at">future_rescaled =</span> future_rescaled, <span class="at">novel_mask =</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>suitable_novel, <span class="sc">:</span> Too few novel climate points <span class="cf">for</span> clustering. Assigning single</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>novel cluster.</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>Analyzing relationships between existing and novel clusters...</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>Warning<span class="sc">:</span> [spatSample] not all classes have <span class="dv">20</span> cells</span></code></pre></div>
<p>However, our classifications cannot accomodate new climate
conditions. We can identify these areas, which are outside of the
training conditions for our SDM using MESS. Note that in these areas our
SDM <em>is</em> extrapolating, so it’s performance cannot be evaluated.
However, it seems that these will possibly be suitable habitat, and we
can try to plan for that scenario.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">future_clusts</span><span class="op">$</span><span class="va">mess</span><span class="op">)</span></span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/plot%20the%20mess%20surfaces-1.png" class="r-plt" alt="" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>bmap <span class="sc">+</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_as_sf</span>(terra<span class="sc">::</span><span class="fu">as.polygons</span>(future_clusts<span class="sc">$</span>novel_mask)), <span class="at">fill =</span> <span class="st">'red'</span>) <span class="sc">+</span> </span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'MESS regions'</span>)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a> [<span class="dv">1</span>m [<span class="dv">22</span>mCoordinate system already present.</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a> [<span class="dv">36</span>mℹ [<span class="dv">39</span>m Adding new coordinate system, which will replace the existing one.</span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/plot%20the%20mess%20surfaces-2.png" class="r-plt" alt="" width="700"></p>
<p>Once we identify these areas, if they are sufficiently large we can
pass them to a new NbClust scenario and it can cluster them anew.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>current <span class="ot">=</span> bmap <span class="sc">+</span> </span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> ENVIbs<span class="sc">$</span>Geometry, <span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">factor</span>(ID))) <span class="sc">+</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Current'</span>, <span class="at">fill =</span> <span class="st">'Cluster'</span>) </span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a> [<span class="dv">1</span>m [<span class="dv">22</span>mCoordinate system already present.</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a> [<span class="dv">36</span>mℹ [<span class="dv">39</span>m Adding new coordinate system, which will replace the existing one.</span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>future <span class="ot">=</span> bmap <span class="sc">+</span> </span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> future_clusts<span class="sc">$</span>clusters_sf, <span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">factor</span>(ID))) <span class="sc">+</span> </span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'2041-2060'</span>, <span class="at">fill =</span> <span class="st">'Cluster'</span>) </span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a> [<span class="dv">1</span>m [<span class="dv">22</span>mCoordinate system already present.</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a> [<span class="dv">36</span>mℹ [<span class="dv">39</span>m Adding new coordinate system, which will replace the existing one.</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>current <span class="sc">+</span> future</span></code></pre></div>
<p><img src="PredictiveProvenance_files/figure-html/identify%20additional%20clusters%20under%20future%20climate-1.png" class="r-plt" alt="" width="700"></p>
<p>However, we also need to determine which current areas are most
similar to these novel climate clusters. We can take values from both
classifcation scenarios, and cluster them, and identify which new
climate clusters share branches with existing clusters. This is the
method we employ to identify the most similar existing climate
groups.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>future_clusts<span class="sc">$</span>novel_similarity</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a> [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="co"># A tibble: 1 × 3 [39m</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  novel_cluster_id nearest_existing_id avg_silhouette_width</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>              [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>dbl<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m                [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>int<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m                 [<span class="dv">3</span>m [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">246</span>m<span class="sc">&lt;</span>dbl<span class="sc">&gt;</span> [<span class="dv">39</span>m [<span class="dv">23</span>m</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a> [<span class="dv">38</span>;<span class="dv">5</span>;<span class="dv">250</span>m1 [<span class="dv">39</span>m               <span class="dv">17</span>                   <span class="dv">6</span>                <span class="fl">0.786</span></span></code></pre></div>
<p>It is from these groups that we are most likely to collect germplasm
relevant for the future scenarios.</p>
<p>We can also take a very quick look at how cluster sizes change
between the scenarios</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>future_clusts<span class="sc">$</span>changes</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>  cluster_id current_area_km2 future_area_km2 area_change_pct centroid_shift_km</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="dv">1</span>          <span class="dv">1</span>      <span class="fl">108734.7003</span>    <span class="fl">129101.28754</span>        <span class="fl">18.73053</span>          <span class="fl">595.3043</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="dv">2</span>          <span class="dv">2</span>       <span class="fl">11572.9955</span>     <span class="fl">71886.09157</span>       <span class="fl">521.15372</span>          <span class="fl">347.1263</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="dv">3</span>          <span class="dv">3</span>       <span class="fl">42691.5031</span>     <span class="fl">13608.50703</span>       <span class="sc">-</span><span class="fl">68.12362</span>          <span class="fl">153.2474</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="dv">4</span>          <span class="dv">4</span>       <span class="fl">28306.6855</span>     <span class="fl">17792.24248</span>       <span class="sc">-</span><span class="fl">37.14473</span>          <span class="fl">357.6163</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="dv">5</span>          <span class="dv">5</span>       <span class="fl">63248.5674</span>     <span class="fl">40340.33393</span>       <span class="sc">-</span><span class="fl">36.21937</span>          <span class="fl">547.6219</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="dv">6</span>          <span class="dv">6</span>       <span class="fl">41937.1189</span>         <span class="fl">0.00000</span>      <span class="sc">-</span><span class="fl">100.00000</span>                <span class="cn">NA</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="dv">7</span>          <span class="dv">7</span>         <span class="fl">462.9198</span>     <span class="fl">36967.24155</span>      <span class="fl">7885.66838</span>          <span class="fl">548.8218</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="dv">8</span>          <span class="dv">8</span>        <span class="fl">6549.4579</span>      <span class="fl">4538.32038</span>       <span class="sc">-</span><span class="fl">30.70693</span>          <span class="fl">894.5692</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="dv">9</span>         <span class="dv">17</span>           <span class="fl">0.0000</span>        <span class="fl">69.43873</span>              <span class="cn">NA</span>                <span class="cn">NA</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>All functions in <code>safeHavens</code> work to identify areas where
populations have the potential to maximize the coverage of neutral and
allelic (genetic) diversity across the species. Large scale restoration
requires the availability of seed sources as the need, and funding
opportunities arise to use them. Developping germplasm materials from
populations that seem adapted to future climate conditions is essential
for future opportunities. While this function does not in any way seek
to identify the best available seed source for a restoration, ala SST or
COSST, it does seek to ensure that the best available option can be
timely applied as the occasion arises.</p>
<p>This is of particular importance for areas that are not able to plan
restorations and develop their own seed sources using point-based
analyses.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Reed Benkendorf.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
